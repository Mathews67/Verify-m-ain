import React, { useState } from 'react';
import { verify_backend } from 'declarations/verify_backend';
import QRCode from 'react-qr-code';
import CertificateTemplate from './CertificateTemplate'; // Import CertificateTemplate
import './TranscriptGenerator.css';  // Importing the custom CSS
import jsPDF from 'jspdf';
import './styles.css'; // Import your new CSS file

const TranscriptGenerator = ({ fetchTotals }) => {
  const [formData, setFormData] = useState({
    name: '',
    program: '',
    year_of_completion: '',
    courses: [],
    year_of_study: ''
  });
  const [generatedCode, setGeneratedCode] = useState('');
  const [qrCodeValue, setQrCodeValue] = useState('');
  const [successMessage, setSuccessMessage] = useState(''); // State for success message

  const studentOptions = [
    'Mathews Tembo', 'Yedidia Chipanta', 'Tembo Profuse', 
    'Gerald Limbando', 'Anet Namuchimba', 'Gift Siwale', 
    'Mubita Mapulanga', 'Mhango Jeremiah', 'Chiyambi Tembo', 
    'Brian Lupasa Muwema', 'Jacob Shinde', 'Flaviour Chipamba'
  ];

  const programOptions = [
    'Bachelor of Computer Science', 'Database Management System', 'Banking and Finance',
    'Food Science and Nutrition', 'Bachelor of Science in Transport and Logistics',
    'Bachelor of Business Administration', 'Human Resource Management'
  ];

  const courseOptions = [
    'Database Management System', 'Information Security', 'Data Science', 
    'Project Management', 'Digital Forensics', 'Banking and Finance',
    'Software Engineering', 'Web Development', 'Mobile App Development',
    'Network Security', 'Machine Learning', 'Cloud Computing', // Add more courses as needed
  ];

  const yearOfStudyOptions = ['First Year', 'Second Year', 'Third Year', 'Fourth Year'];

  const yearOfCompletionOptions = Array.from(
    { length: 2024 - 2000 + 1 },
    (v, k) => 2000 + k
  ); // Years from 2000 to 2024

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prevState => ({
      ...prevState,
      [name]: value
    }));
  };

  const handleCourseChange = (e) => {
    const selectedCourses = Array.from(e.target.selectedOptions, option => option.value);
    setFormData(prevState => ({
      ...prevState,
      courses: selectedCourses // Store selected courses as an array
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const autoGeneratedId = 'TRANS-' + Math.floor(Math.random() * 1000000); // Auto-generate Transcript ID
    try {
      const result = await verify_backend.createTranscript(
        autoGeneratedId,
        formData.name,
        formData.program,
        formData.year_of_completion,
        formData.courses // Pass the selected courses array directly
      );
      setGeneratedCode(result);
      setQrCodeValue(result); // Set QR code value for Certificate Template
      fetchTotals(); // Update totals after generation
      setSuccessMessage('Transcript generated successfully!'); // Set success message
      setTimeout(() => {
        setSuccessMessage(''); // Clear the message after 3 seconds
      }, 3000);
    } catch (error) {
      console.error("Error generating transcript:", error);
    }
  };

  const handleDownloadPDF = () => {
    const doc = new jsPDF();
    doc.text(`Transcript Code: ${generatedCode}`, 10, 10);
    doc.text(`Name: ${formData.name}`, 10, 20);
    doc.text(`Program: ${formData.program}`, 10, 30);
    doc.text(`Year of Completion: ${formData.year_of_completion}`, 10, 40);
    doc.text(`Courses: ${formData.courses.join(', ')}`, 10, 50); // Display selected courses

    // Create QR code image dynamically for PDF
    const qrCodeCanvas = document.querySelector("#qrcode > canvas");
    const qrImage = qrCodeCanvas.toDataURL("image/png");

    doc.addImage(qrImage, 'PNG', 10, 60, 50, 50);

    // Open PDF in new tab
    const pdfUrl = doc.output('bloburl');
    window.open(pdfUrl, '_blank');
  };

  return (
    <div className="form-container">
      <h2>Generate Transcript</h2>
      <form onSubmit={handleSubmit}>
        <label className="label">Name:</label>
        <select
          className="input-field"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
        >
          <option value="">Select a student</option>
          {studentOptions.map((student, index) => (
            <option key={index} value={student}>{student}</option>
          ))}
        </select>

        <label className="label">Program:</label>
        <select
          className="input-field"
          name="program"
          value={formData.program}
          onChange={handleChange}
          required
        >
          <option value="">Select a program</option>
          {programOptions.map((program, index) => (
            <option key={index} value={program}>{program}</option>
          ))}
        </select>

        <label className="label">Year of Completion:</label>
        <select
          className="input-field"
          name="year_of_completion"
          value={formData.year_of_completion}
          onChange={handleChange}
          required
        >
          <option value="">Select year of completion</option>
          {yearOfCompletionOptions.map((year) => (
            <option key={year} value={year}>{year}</option>
          ))}
        </select>

        <label className="label">Courses (select multiple):</label>
        <select
          className="input-field"
          multiple={true}
          onChange={handleCourseChange}
          required
        >
          {courseOptions.map((course, index) => (
            <option key={index} value={course}>{course}</option>
          ))}
        </select>

        <label className="label">Year of Study:</label>
        <select
          className="input-field"
          name="year_of_study"
          value={formData.year_of_study}
          onChange={handleChange}
          required
        >
          <option value="">Select year of study</option>
          {yearOfStudyOptions.map((year, index) => (
            <option key={index} value={year}>{year}</option>
          ))}
        </select>

        <button className="button" type="submit">Submit</button>
      </form>

      {successMessage && <div className="success-message">{successMessage}</div>} {/* Display success message */}

      {generatedCode && (
        <div>
          <h3>Generated Transcript Code: {generatedCode}</h3>
          <button className="button" onClick={handleDownloadPDF}>Download PDF</button>

          {/* Display certificate template with QR code */}
          <CertificateTemplate
            studentName={formData.name}
            courseName={formData.program}
            issueDate={formData.year_of_completion}
            qrCodeValue={qrCodeValue} // Passing the QR code value to the template
          />
        </div>
      )}
    </div>
  );
};

export default TranscriptGenerator;
